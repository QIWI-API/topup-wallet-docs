# QIWI Wallet Top-Up {#payment}

###### [Edit on Github](https://github.com/QIWI-API/topup-wallet-doc/blob/master/_topup_en.html.md)

QIWI Wallet top-ups are payment transactions within QIWI Wallet system that debit Agent account and credit user QIWI Wallet account. **You have to [check if the top-up is possible](#check-deposit) before the request**.

If the specified user account does not exist, QIWI Wallet system creates it automatically while processing the top-up request.

**The Agent must specify the type of funds that is received from the client — cash or non-cash funds, in `extra name="income_wire_transfer"` parameter**.

The top-up request initiates the payment lifecycle. During the lifecycle, the payment proceeds through several statuses. All payment transactions, including top-up requests, are processed asynchronously. A request that is accepted successfully may then fail. The Agent’s system should query current [payment status](#status) from QIWI Wallet periodically (no more than once in 10 minutes), until a final status code, successful or unsuccessful, is received.

## Request format {#payment-req}

### Request parameters

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<request>
  <request-type>pay</request-type>
  <terminal-id>123</terminal-id>
  <extra name="password">***</extra>
  <extra name="income_wire_transfer">1</extra>
  <auth>
    <payment>
      <transaction-number>12345678</transaction-number>
      <from>
        <ccy>RUB</ccy>
      </from>
      <to>
        <amount>1115.00</amount>
        <ccy>RUB</ccy>
        <service-id>99</service-id>
        <account-number>79181234567</account-number>
      </to>
    </payment>
  </auth>
</request>
~~~

Tag|Description
--------|------
*request* | A grouping tag. The child tags contain payment parameters
*request-type* | Request type identifier (QIWI Wallet top-up request: `pay`)
*terminal-id* | Agent ID in QIWI Wallet system
*extra name="password"* | Agent's password in QIWI Wallet system
*extra name="income_wire_transfer"* | The type of funds that the Agent received from the client - cash (0) or non-cash (1)
*auth* | A grouping tag that describes payment data
*payment* | A grouping tag that describes single payment details. **There must be only one such tag in the request.**
*transaction-number* | transaction number generated by the Agent’s system. This number should be used in [payment status check request](#status). Transaction number and Agent ID make a uniquely identified transaction in QIWI Wallet system.
*from* | A grouping tag that contains payment details related to Agent's account
*from/ccy* | Currency of the Agent's balance that will be charged for the payment (numeric or character code of currency according  to ISO 4217)
*from/service-id* | Top-up source identifier (optional). The `service-id` parameter is used when it is necessary to separate QIWI Wallet top-up sources in the Agent's balance.
*to* |A grouping tag with the payment details
*to/amount* | Amount to be credited to QIWI Wallet user account. QIWI Wallet system limits payment amount taking into account conditions on a money balance on QIWI Wallet user account specified in QIWI Wallet offer <https://static.qiwi.com/ru/doc/oferta_lk.pdf>. Amounts less than allowed and greater than allowed are not accepted. The operation will be finished with [result code](#error) `241` and `242`, respectively.
*to/service-id* | Service identifier (constant: `99`)
*to/account-number* | QIWI Wallet user ID, i.e. the mobile phone number in international format
*to/ccy* | Currency of the user (recipient) account where payment is debited (numeric or character code of currency according  to ISO 4217)
*to/extra="comment"* | Payment comment (optional)

## Response format {#payment-res}

The Agent’s system should process errors in response as follows.

In case of network error (connection or response timeout) or HTTP error (HTTP status code other than 200, or empty HTTP response), incorrect XML-documents (no required tag/attribute) the Agent’s system should request payment status until final successful or unsuccessful payment status. Transaction status information is inaccessible in case of these errors, so the Agent should not denies the payment on its side.

Fatal errors mean that sending a secondary request with the same parameters will result in the same error. Fatal errors are often caused by invalid configuration and require manual intervention (contact QIWI Wallet Support by <a href="mailto:bss@qiwi.com">bss@qiwi.com</a>).

In case of fatal error, the Agent’s system may either keep repeating requests, or pause repeating the request until the configuration is corrected. Agent’s system needs not to deny payment as transaction status is unknown on request processing error.


### Successful request processing

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<response>
<payment status='60' txn_id='6060' transaction-number='12345678' result-code='0' final-status='true' fatal-error='false' txn-date='02.03.2011 14:35:46'  >
  <from>
    <amount>1115.00</amount>
    <ccy>643</ccy>
  </from>
  <to>
    <service-id>99</service-id>
    <amount>1000.00</amount>
    <ccy>643</ccy>
    <account-number>79181234567</account-number>
  </to>
</payment>
<balances>
<balance code="428">0.00</balance>
<balance code="643">200.00</balance>
<balance code="840">12.20</balance>
</balances>
</response>
~~~

Response data:

Tag|Description|Attributes
--------|------|---------
*response*	| A grouping tag|No
*payment* | Details of the accepted payment| `status` – [payment status](#statuses) in QIWI Wallet system;
 | |`txn_id` – transaction ID in QIWI Wallet system. **If empty, the payment was not registered due to temporary error. You have to repeat the request later.**;
 | |`transaction-number` – transaction number in the Agent’s system;
 | |`result-code` – payment processing [error code](#error);
 | |`final-status` – logical flag indicating if payment’s status is final;
 | |`fatal-error` - logical flag indicating if payment’s processing error is fatal;
 | |`txn-date` – date and time when the payment was accepted by QIWI Wallet system.
*from*|A grouping tag with information about charged money from the Agent's account|No
*from/amount* | The amount charged from the Agent's account|No
*from/ccy* | Currency of the Agent's account (numeric or character code of currency according to ISO 4217)|No
*to*|A grouping tag with payment details|No
*amount* | The amount credited to QIWI Wallet user account|No
*to/service-id* | Service identifier (constant: `99`)|No
*to/account-number* | QIWI Wallet user ID, i.e. the mobile phone number|No
*to/ccy* | Currency of the payment (numeric or character code of currency according to ISO 4217)|No
*balances*|A grouping tag. Child tags corresponds to the Agent's account balances in QIWI Wallet system after the payments was accepted|No
*balances/balance* | Value of balance in currency of the Agent's account| `code` - shows the currency of the Agent's balance (numeric code of currency according  to ISO 4217)

### Error response

If QIWI Wallet server is unable to process the request, the response is as described here.

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<response>
  <result-code fatal="false">300</result-code>
</response>
~~~

Response data:

Tag|Description|Attributes
--------|------|---------
*result-code* | Request processing error [code](#tech_error)| `fatal` – logical flag indicating if request processing error is fatal
