# Выплаты на счета мобильных телефонов {#payment}

Операция используется для выплаты средств на счета мобильных телефонов мобильных операторов РФ. Выплата средств в системе QIWI Wallet представляет собой списание средств с авансового депозита агента на баланс клиента системы QIWI Wallet и одновременное списание средств в пользу указанного мобильного оператора. При этом с клиента может взиматься комиссия в соответствии с тарифами, размещенными по адресу: <https://qiwi.com/bank/rates>

Если клиент с указанным идентификатором не существует в системе QIWI Wallet, то он будет создан в момент регистрации платежа.

Для проверки успешного прохождения платежа, вы должны периодически (но не чаще одного раза в 10 минут) выполнять [запрос проверки статуса платежа](#status) до получения успешного или неуспешного финального статуса платежа.

При возникновении сетевых ошибок (например, таймауты при соединении или чтении ответа), HTTP-ошибок (HTTP-статус не равен 200, пустой ответ), некорректных XML-документов (например, c отсутствующими обязательными тегами и/или атрибутами) вы также должны перейти к периодическому [запросу статуса платежа](#status) до получения успешного или неуспешного финального статуса платежа. Поскольку при возникновении данных ошибок информация о статусе платежа не доступна, вы не должны отклонять платёж на своей стороне.

Фатальность ошибки означает, что повторный запрос с теми же реквизитами приведет к повторению той же ошибки. Фатальные ошибки, как правило, вызваны ошибками конфигурирования и требуют ручного вмешательства (обращения в службу поддержки сервиса QIWI Wallet по адресу  <a href="mailto:bss@qiwi.com">bss@qiwi.com</a>).

При появлении фатальных ошибок обработки запроса вы можете не приостанавливать выполнение повторных запросов, либо приостановить до устранения ошибок конфигурирования. Поскольку при ошибках обработки запроса статус платежа неизвестен, вы не должны отклонять платёж.

## Формат запроса {#payment-req}

### Параметры запроса

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<request>
	<request-type>pay</request-type>
	<terminal-id>123</terminal-id>
	<extra name="password">***</extra>
	<auth>
		<payment>
			<transaction-number>12345678</transaction-number>
			<from>
				<ccy>RUB</ccy>
			</from>
			<to>
				<amount>115.00</amount>
				<ccy>RUB</ccy>
				<service-id>29130</service-id>
				<account-number>7988111****</account-number>
				<extra name="account0">id:2;acc:988111****;sum:115.00</extra>
			</to>
		</payment>
	</auth>
</request>
~~~

Тег|Описание
--------|------
*request* |Группирующий тег. Дочерние теги содержат параметры платежа.
*request-type* | Тип запроса (идентификатор запроса выплаты: `pay`)
*terminal-id* | Идентификатор агента в системе QIWI Wallet
*extra name="password"* | Экстра-поле, содержащее пароль для аутентификации агента в системе QIWI Wallet
*auth* |Группирующий тег, описывает платежные данные
*payment* | Группирующий тег, описывает единичный платеж. **В запросе может присутствовать только один тег `payment`.**
*transaction-number* | Номер транзакции платежа в информационной системе агента. Его необходимо использовать при [проверке статуса платежа](#status). Номер транзакции и идентификатор `terminal-id` однозначно определяют платёж в системе QIWI Wallet.
*from* | Группирующий тег, содержит информацию о сумме, полученной агентом от клиента
*from/ccy* | Валюта счета агента, с которого будет произведено списание денежных средств (в качестве значения используется цифровой или буквенный код валюты по ISO 4217)
*from/service-id* | Идентификатор источника (канала) пополнения (необязательный параметр). Параметр используется в случае необходимости разделения потоков пополнения мобильных телефонов, сохраняя единый баланс агента.
*to* |Группирующий тег, содержит информацию о платеже
*to/amount* | Сумма выплаты на счет мобильного телефона
*to/service-id* | Идентификатор сервиса, на который производится зачисление средств при выплате (константа: `29130`)
*to/account-number* | Идентификатор Клиента в системе QIWI Wallet (совпадает с номером мобильного телефона).
*to/extra name="account0"* | Описание транзитной транзакции (в формате *параметр1:значение;параметр2:значение;..*). Должны быть указаны параметры:<br>`id` - идентификатор провайдера, на которого будет создана транзитная транзакция (определяется [отдельным запросом](#get-provider));<br>`acc` - номер мобильного телефона Клиента (без указания кода страны);<br>`sum` - сумма платежа, взимаемая с клиента с учетом тарифов, в рублях и копейках (разделитель `.`).
*to/ccy* | Валюта учетной записи Клиента в системе QIWI Wallet. Опциональный параметр. В случае его передачи проверяется наличие у Клиента учетной записи в данной валюте. В качестве значения используется цифровой или буквенный код валюты по ISO 4217.

## Формат ответа {#payment-res}

### Ответ без ошибок обработки

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<response>
<payment status='60' txn_id='6060' transaction-number='12345678' result-code='0' final-status='true' fatal-error='false' txn-date='02.03.2011 14:35:46'  >
  <from>
    <amount>15.00</amount>
    <ccy>643</ccy>
  </from>
  <to>
    <service-id>29130</service-id>
    <amount>115.00</amount>
    <ccy>643</ccy>
    <account-number>7988111****</account-number>
  </to>
</payment>
<balances>
<balance code="428">0.00</balance>
<balance code="643">200</balance>
<balance code="840">12.20</balance>
</balances>
</response>
~~~

**Параметры ответа:**

 Тег|Описание|Атрибуты
--------|------|---------
*response*	| Группирующий тег ответа.|Отсутствуют.
*payment* | Описание принятого платежа.| `status` – [статус платежа](#statuses) в системе QIWI Wallet;
 | |`txn_id` – идентификатор транзакции платежа в системе QIWI Wallet. **Если не заполнен, платёж не был зарегистрирован из-за временной ошибки. Попробуйте повторить запрос позже**;
 | |`transaction-number` – номер транзакции платежа в информационной системе Контрагента;
 | |`result-code` – [код](#error) ошибки обработки платежа;
 | |`final-status` – флаг, определяющий финальность статуса платежа;
 | |`fatal-error` - флаг, определяющий фатальность ошибки обработки платежа;
 | |`txn-date` – дата приема платежа в систему QIWI Wallet;
*from* |Группирующий тег, содержит информацию о списанных средствах.|Отсутствуют.
*from/amount* | Сумма, списанная со счета Контрагента.|Отсутствуют.
*from/ccy* | Валюта счета (в качестве значения используется цифровой или буквенный код валюты по ISO 4217).|Отсутствуют.
*to* |Группирующий тег, содержит информацию о платеже.|Отсутствуют.
*to/amount* | Сумма к зачислению на счет мобильного телефона.|Отсутствуют.
*to/service-id* | Идентификатор сервиса, на который производится зачисление средств при выплате.|Отсутствуют.
*to/account-number* | Номер мобильного телефона Клиента.|Отсутствуют.
*to/ccy* | Валюта выплаты (цифровой или буквенный код валюты по ISO 4217).|Отсутствуют.
*balances* |Группирующий тег, содержит информацию о балансе всех активных счетов Контрагента в системе QIWI Wallet.|Отсутствуют.
*balances/balance* | Текущий баланс единичного счета Контрагента в системе QIWI Wallet| `code` - цифровой код валюты счета (в формате ISO 4217).

### Ответ с ошибками обработки

Если сервер не смог обработать запрос в системе QIWI Wallet, он возвращает XML-ответ с описанием произошедшей ошибки.

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<response>
  <result-code fatal="false">300</result-code>
</response>
~~~

**Параметры ответа:**

 Тег|Описание|Атрибуты
--------|------|---------
*result-code* | [Код](#tech_error) ошибки обработки запроса.| `fatal` – логический признак фатальности ошибки обработки запроса.

# Определение ID провайдера по номеру телефона {#get-provider}

Данный запрос используется для определения ID провайдера мобильной связи по номеру телефона, т.е. определения принадлежности абонента.

**Запросы должны отправляться на URL**

`https://api.qiwi.com/xml/xmlcp.jsp` 

**При [авторизации по сертификату](#ssl-auth) запросы должны отправляться на URL**

`https://private-api.qiwi.com/xml/xmlcp.jsp`

## Формат запроса

### Параметры запроса

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<request>
<request-type>get-provider-by-phone-number</request-type>
<terminal-id>***</terminal-id>
<phonenumber>916*******</phonenumber>
<extra name="password">***</extra>
</request>
~~~

Тег|Описание
--------|------
*request-type* | Тип запроса (идентификатор запроса определения ID провайдера: `get-provider-by-phone-number`)
*terminal-id* | Идентификатор агента в системе QIWI Wallet
*extra name="password"* | Экстра-поле, содержащее пароль для аутентификации агента в системе QIWI Wallet
*phonenumber* | Номер телефона Клиента, по которому нужно определить id провайдера (без указания кода страны)

## Формат ответа

### Ответ без ошибок обработки запроса

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<response>
<result-code fatal="false" message="Ок" msg="Ок">0</result-code>
<provider id="42"/>
</response>
~~~

Параметры ответа:

Тег|Описание|Атрибуты
--------|------|---------
*result-code* | [Результат](#tech_error) выполнения запроса на сервере QIWI Wallet| `fatal` – логический признак фатальности ошибки обработки запроса.<br>`message`, `msg` – текстовое сообщение
*provider* | Идентификатор провайдера| `id` – значение идентификатора

### Ответ с ошибками обработки запроса

Если сервер не смог обработать запрос, он возвращает xml-ответ с описанием произошедшей ошибки.

~~~xml
<?xml version="1.0" encoding="utf-8"?>
<response>
  <result-code fatal="false">300</result-code>
</response>
~~~

Параметры ответа:

 Тег|Описание|Атрибуты
--------|------|---------
*result-code* | [Код](#tech_error) ошибки обработки запроса.| `fatal` – логический признак фатальности ошибки обработки запроса.
